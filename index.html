<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© a1.jpeg</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, Arial, sans-serif;
      background: #f3f3f3;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 20px;
      text-align: center;
    }

    .toolbar {
      margin-bottom: 10px;
      padding: 10px 15px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .toolbar label {
      margin-inline-end: 4px;
    }

    .toolbar select,
    .toolbar input[type="number"],
    .toolbar input[type="color"],
    .toolbar button {
      padding: 4px 6px;
      font-size: 13px;
    }

    .toolbar button {
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fafafa;
    }

    .toolbar button.primary {
      background: #2d8cf0;
      color: #fff;
      border-color: #2d8cf0;
    }

    .toolbar button.bold-btn {
      font-weight: bold;
    }

    .toolbar button.bold-btn.active {
      background: #ddd;
    }

    #editor-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 10px 0 30px;
    }

    #image-container {
      position: relative;
      display: inline-block;
      touch-action: none; /* Ù…Ù‡Ù… Ù„Ù„Ø¬ÙˆØ§Ù„ */
    }

    #base-image {
      display: block;
      max-width: 95vw;
      height: auto;
    }

    .text-box {
      position: absolute;
      min-width: 80px;
      min-height: 30px;
      padding: 4px 6px;
      border: 1px dashed rgba(0,0,0,0.3);
      border-radius: 4px;
      background: transparent;
      color: #000;
      font-size: 18px;
      cursor: text;
      user-select: text;
      white-space: pre-wrap;
      outline: none;
      touch-action: none; /* ÙŠÙ…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø¯Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹ */
      text-align: right; /* Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ ÙŠÙ…ÙŠÙ† Ù„Ø£Ù†Ù†Ø§ Ø¹Ø±Ø¨ÙŠ */
    }

    .text-box.active {
      border-color: #2d8cf0;
      box-shadow: 0 0 0 1px rgba(45,140,240,0.4);
    }

    .hint {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      text-align: center;
      padding: 0 10px;
    }
  </style>
</head>
<body>
  <h1>Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© a1.jpeg</h1>

  <div class="toolbar" id="toolbar">
    <button id="add-text" class="primary" onclick="createTextBox()">+ Ø¥Ø¶Ø§ÙØ© Ù†Øµ</button>
    <button id="delete-text">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
    <button id="export-image">â¬‡ ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button>

    <span>|</span>

    <label for="font-family">Ø§Ù„Ø®Ø·:</label>
    <select id="font-family">
      <option value="Arial">Arial</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Courier New">Courier New</option>
      <option value="Times New Roman">Times New Roman</option>
    </select>

    <label for="font-size">Ø§Ù„Ø­Ø¬Ù…:</label>
    <input id="font-size" type="number" value="22" min="8" max="120">

    <label for="font-color">Ø§Ù„Ù„ÙˆÙ†:</label>
    <input id="font-color" type="color" value="#000000">

    <label for="text-align">Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©:</label>
    <select id="text-align">
      <option value="right" selected>ÙŠÙ…ÙŠÙ†</option>
      <option value="center">ÙˆØ³Ø·</option>
      <option value="left">ÙŠØ³Ø§Ø±</option>
    </select>

    <button id="bold-toggle" class="bold-btn">B</button>

    <label>
      <input type="checkbox" id="move-mode">
      ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠÙƒ / Ø§Ù„ØªÙƒØ¨ÙŠØ±
    </label>
  </div>

  <div class="hint">
    ğŸ“± Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ù„:<br>
    - Ø§ÙƒØªØ¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© (ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠÙƒ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„).<br>
    - ÙØ¹Ù‘Ù„ "ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠÙƒ / Ø§Ù„ØªÙƒØ¨ÙŠØ±":<br>
    &nbsp;&nbsp;â€¢ Ø¥ØµØ¨Ø¹ ÙˆØ§Ø­Ø¯: Ø³Ø­Ø¨ Ø§Ù„Ù…Ø±Ø¨Ø¹.<br>
    &nbsp;&nbsp;â€¢ Ø¥ØµØ¨Ø¹Ø§Ù†: ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù…Ø¹ Ø§Ù„Ù†Øµ (Pinch).<br>
    - Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© (ÙŠÙ…ÙŠÙ†/ÙˆØ³Ø·/ÙŠØ³Ø§Ø±) Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ·.<br>
    - Ø£Ù„ØºÙ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙƒØªØ§Ø¨Ø©.
  </div>

  <div id="editor-wrapper">
    <div id="image-container">
      <img id="base-image" src="a1.jpeg" alt="a1">
    </div>
  </div>

  <script>
    const img = document.getElementById('base-image');
    const container = document.getElementById('image-container');
    const toolbar = document.getElementById('toolbar');
    const deleteTextBtn = document.getElementById('delete-text');
    const exportBtn = document.getElementById('export-image');
    const fontFamilySelect = document.getElementById('font-family');
    const fontSizeInput = document.getElementById('font-size');
    const fontColorInput = document.getElementById('font-color');
    const textAlignSelect = document.getElementById('text-align');
    const boldBtn = document.getElementById('bold-toggle');
    const moveModeCheckbox = document.getElementById('move-mode');

    let activeBox = null;

    // Ø³Ø­Ø¨ (Pointer Events)
    let dragInfo = null; // { box, pointerId, offsetX, offsetY }

    // ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± (Pinch)
    let pinchInfo = null; // { box, startDist, startFontSize, startWidth, startHeight }

    img.addEventListener('load', () => {
      container.style.width = img.clientWidth + 'px';
      container.style.height = img.clientHeight + 'px';
    });

    // ========= Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¨Ø¹ Ù†Øµ =========
    function createTextBox() {
      const box = document.createElement('div');
      box.className = 'text-box';
      box.contentEditable = 'true';
      box.textContent = 'Ø§ÙƒØªØ¨ Ù‡Ù†Ø§';

      box.style.left = '20px';
      box.style.top = '20px';
      box.style.fontFamily = fontFamilySelect.value;
      box.style.fontSize = fontSizeInput.value + 'px';
      box.style.color = fontColorInput.value;
      box.style.fontWeight = 'normal';
      box.style.textAlign = textAlignSelect.value; // Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ù† Ø§Ù„ØªÙˆÙ„Ø¨Ø§Ø±

      container.appendChild(box);
      setActiveBox(box);

      // Ø³Ø­Ø¨ Ø¨Ø§Ù„Ù…Ø¤Ø´Ø± (Ù…Ø§ÙˆØ³ Ø£Ùˆ Ø¥ØµØ¨Ø¹ ÙˆØ§Ø­Ø¯) Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠÙƒ
      box.addEventListener('pointerdown', (e) => {
        if (!moveModeCheckbox.checked) {
          setActiveBox(box);
          return;
        }

        // Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù€ Pinch Ù„Ø§ Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨
        if (pinchInfo) return;

        if (e.button !== 0 && e.pointerType === 'mouse') return;

        e.preventDefault();
        setActiveBox(box);

        const rect = box.getBoundingClientRect();
        dragInfo = {
          box: box,
          pointerId: e.pointerId,
          offsetX: e.clientX - rect.left,
          offsetY: e.clientY - rect.top
        };

        box.contentEditable = 'false';
        box.setPointerCapture(e.pointerId);
      });

      box.addEventListener('pointermove', (e) => {
        if (!dragInfo || dragInfo.pointerId !== e.pointerId) return;
        const { box, offsetX, offsetY } = dragInfo;

        const containerRect = container.getBoundingClientRect();
        let newLeft = e.clientX - containerRect.left - offsetX;
        let newTop = e.clientY - containerRect.top - offsetY;

        const maxLeft = containerRect.width - box.offsetWidth;
        const maxTop = containerRect.height - box.offsetHeight;

        newLeft = Math.max(0, Math.min(newLeft, maxLeft));
        newTop = Math.max(0, Math.min(newTop, maxTop));

        box.style.left = newLeft + 'px';
        box.style.top = newTop + 'px';
      });

      const endDrag = (e) => {
        if (!dragInfo || dragInfo.pointerId !== e.pointerId) return;
        dragInfo.box.contentEditable = 'true';
        dragInfo.box.releasePointerCapture(e.pointerId);
        dragInfo = null;
      };

      box.addEventListener('pointerup', endDrag);
      box.addEventListener('pointercancel', endDrag);

      // Pinch: ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± Ø¨Ø§Ù„Ù…Ø³ Ø¨Ø¥ØµØ¨Ø¹ÙŠÙ† (Touch Events)
      box.addEventListener('touchstart', (e) => {
        if (!moveModeCheckbox.checked) return;
        if (e.touches.length !== 2) return;
        e.preventDefault();

        const t1 = e.touches[0];
        const t2 = e.touches[1];
        const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);

        const style = window.getComputedStyle(box);
        const rect = box.getBoundingClientRect();

        // Ù†Ø«Ø¨Øª Ø¹Ø±Ø¶ ÙˆØ§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù‚Ø¨Ù„ Ø§Ù„ØªÙƒØ¨ÙŠØ±
        box.style.width = rect.width + 'px';
        box.style.height = rect.height + 'px';

        pinchInfo = {
          box,
          startDist: dist,
          startFontSize: parseFloat(style.fontSize),
          startWidth: rect.width,
          startHeight: rect.height
        };
      }, { passive: false });

      box.addEventListener('touchmove', (e) => {
        if (!pinchInfo) return;
        if (e.touches.length !== 2) return;
        e.preventDefault();

        const t1 = e.touches[0];
        const t2 = e.touches[1];
        const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
        if (dist <= 0) return;

        const scale = dist / pinchInfo.startDist;

        // Ø­Ø¯ÙˆØ¯ Ù…Ø¹Ù‚ÙˆÙ„Ø© Ù„Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±
        const minScale = 0.5;
        const maxScale = 3;
        const clampedScale = Math.max(minScale, Math.min(maxScale, scale));

        const newWidth = pinchInfo.startWidth * clampedScale;
        const newHeight = pinchInfo.startHeight * clampedScale;
        const newFontSize = pinchInfo.startFontSize * clampedScale;

        pinchInfo.box.style.width = newWidth + 'px';
        pinchInfo.box.style.height = newHeight + 'px';
        pinchInfo.box.style.fontSize = newFontSize + 'px';
      }, { passive: false });

      box.addEventListen
