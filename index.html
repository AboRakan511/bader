<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© a1.jpeg</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, Arial, sans-serif;
      background: #f3f3f3;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 20px;
      text-align: center;
    }

    .toolbar {
      margin-bottom: 10px;
      padding: 10px 15px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .toolbar label {
      margin-inline-end: 4px;
    }

    .toolbar select,
    .toolbar input[type="number"],
    .toolbar input[type="color"],
    .toolbar button {
      padding: 4px 6px;
      font-size: 13px;
    }

    .toolbar button {
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fafafa;
    }

    .toolbar button.primary {
      background: #2d8cf0;
      color: #fff;
      border-color: #2d8cf0;
    }

    .toolbar button.bold-btn {
      font-weight: bold;
    }

    .toolbar button.bold-btn.active {
      background: #ddd;
    }

    #editor-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 10px 0 30px;
    }

    #image-container {
      position: relative;
      display: inline-block;
      touch-action: none; /* ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø³Ø­Ø¨ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª */
    }

    #base-image {
      display: block;
      max-width: 95vw;
      height: auto;
    }

    .text-box {
      position: absolute;
      min-width: 80px;
      min-height: 30px;
      padding: 4px 6px;
      border: 1px dashed rgba(0,0,0,0.3);
      border-radius: 4px;
      background: transparent;
      color: #000;
      font-size: 18px;
      cursor: text;
      user-select: text;
      white-space: pre-wrap;
      outline: none;
    }

    .text-box.active {
      border-color: #2d8cf0;
      box-shadow: 0 0 0 1px rgba(45,140,240,0.4);
    }

    .hint {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      text-align: center;
      padding: 0 10px;
    }
  </style>
</head>
<body>
  <h1>Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© a1.jpeg</h1>

  <div class="toolbar" id="toolbar">
    <button id="add-text" class="primary" onclick="createTextBox()">+ Ø¥Ø¶Ø§ÙØ© Ù†Øµ</button>
    <button id="delete-text">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
    <button id="export-image">â¬‡ ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button>

    <span>|</span>

    <label for="font-family">Ø§Ù„Ø®Ø·:</label>
    <select id="font-family">
      <option value="Arial">Arial</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Courier New">Courier New</option>
      <option value="Times New Roman">Times New Roman</option>
    </select>

    <label for="font-size">Ø§Ù„Ø­Ø¬Ù…:</label>
    <input id="font-size" type="number" value="22" min="8" max="120">

    <label for="font-color">Ø§Ù„Ù„ÙˆÙ†:</label>
    <input id="font-color" type="color" value="#000000">

    <button id="bold-toggle" class="bold-btn">B</button>

    <label>
      <input type="checkbox" id="move-mode">
      ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠÙƒ
    </label>
  </div>

  <div class="hint">
    Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±:  
    Ø§ÙƒØªØ¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©. Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙØ¹Ù‘Ù„ "ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠÙƒ" Ø«Ù… Ø§Ø³Ø­Ø¨Ù‡ Ø¨Ø¥ØµØ¨Ø¹Ùƒ (Ø£Ùˆ Ø§Ù„Ù…Ø§ÙˆØ³)ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø£Ù„ØºÙ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙƒØªØ§Ø¨Ø©.
  </div>

  <div id="editor-wrapper">
    <div id="image-container">
      <img id="base-image" src="a1.jpeg" alt="a1">
    </div>
  </div>

  <script>
    const img = document.getElementById('base-image');
    const container = document.getElementById('image-container');
    const toolbar = document.getElementById('toolbar');
    const deleteTextBtn = document.getElementById('delete-text');
    const exportBtn = document.getElementById('export-image');
    const fontFamilySelect = document.getElementById('font-family');
    const fontSizeInput = document.getElementById('font-size');
    const fontColorInput = document.getElementById('font-color');
    const boldBtn = document.getElementById('bold-toggle');
    const moveModeCheckbox = document.getElementById('move-mode');

    let activeBox = null;
    let dragInfo = null; // { box, offsetX, offsetY }

    img.addEventListener('load', () => {
      container.style.width = img.clientWidth + 'px';
      container.style.height = img.clientHeight + 'px';
    });

    // ========= Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¨Ø¹ Ù†Øµ =========
    function createTextBox() {
      const box = document.createElement('div');
      box.className = 'text-box';
      box.contentEditable = 'true';
      box.textContent = 'Ø§ÙƒØªØ¨ Ù‡Ù†Ø§';

      box.style.left = '20px';
      box.style.top = '20px';
      box.style.fontFamily = fontFamilySelect.value;
      box.style.fontSize = fontSizeInput.value + 'px';
      box.style.color = fontColorInput.value;
      box.style.fontWeight = 'normal';

      container.appendChild(box);
      setActiveBox(box);

      // Ø³Ø­Ø¨ Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ù…ÙØ¹Ù‘Ù„
      box.addEventListener('mousedown', (e) => {
        if (!moveModeCheckbox.checked) return;
        if (e.button !== 0) return;
        e.preventDefault();

        setActiveBox(box);
        const rect = box.getBoundingClientRect();
        dragInfo = {
          box: box,
          offsetX: e.clientX - rect.left,
          offsetY: e.clientY - rect.top
        };
        box.contentEditable = 'false';
      });

      // Ø³Ø­Ø¨ Ø¨Ø§Ù„Ù„Ù…Ø³ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ù…ÙØ¹Ù‘Ù„
      box.addEventListener('touchstart', (e) => {
        if (!moveModeCheckbox.checked) return;
        const touch = e.touches[0];
        if (!touch) return;
        e.preventDefault();

        setActiveBox(box);
        const rect = box.getBoundingClientRect();
        dragInfo = {
          box: box,
          offsetX: touch.clientX - rect.left,
          offsetY: touch.clientY - rect.top
        };
        box.contentEditable = 'false';
      }, { passive: false });

      // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø¨Ø¹ (ÙƒØªØ§Ø¨Ø© Ø¹Ø§Ø¯ÙŠØ© ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
      box.addEventListener('click', (e) => {
        setActiveBox(box);
        e.stopPropagation();
      });

      return box;
    }

    // ========= ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Ø´Ø· =========
    function setActiveBox(box) {
      if (activeBox && activeBox !== box) {
        activeBox.classList.remove('active');
      }
      activeBox = box;
      if (activeBox) {
        activeBox.classList.add('active');

        const style = window.getComputedStyle(activeBox);
        fontFamilySelect.value = style.fontFamily.replace(/"/g,'').split(',')[0] || 'Arial';
        fontSizeInput.value = parseInt(style.fontSize) || 22;

        const rgb = style.color.match(/\d+/g);
        if (rgb && rgb.length >= 3) {
          const toHex = (n) => parseInt(n).toString(16).padStart(2, '0');
          fontColorInput.value = '#' + toHex(rgb[0]) + toHex(rgb[1]) + toHex(rgb[2]);
        }

        const fw = style.fontWeight;
        const isBold = fw === '700' || fw === 'bold';
        boldBtn.classList.toggle('active', isBold);
      }
    }

    // ========= Ø³Ø­Ø¨ Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ =========
    document.addEventListener('mousemove', (e) => {
      if (!dragInfo) return;
      const { box, offsetX, offsetY } = dragInfo;

      const containerRect = container.getBoundingClientRect();
      let newLeft = e.clientX - containerRect.left - offsetX;
      let newTop = e.clientY - containerRect.top - offsetY;

      const maxLeft = containerRect.width - box.offsetWidth;
      const maxTop = containerRect.height - box.offsetHeight;

      newLeft = Math.max(0, Math.min(newLeft, maxLeft));
      newTop = Math.max(0, Math.min(newTop, maxTop));

      box.style.left = newLeft + 'px';
      box.style.top = newTop + 'px';
    });

    document.addEventListener('mouseup', () => {
      if (dragInfo && dragInfo.box) {
        dragInfo.box.contentEditable = 'true';
      }
      dragInfo = null;
    });

    // ========= Ø³Ø­Ø¨ Ø¨Ø§Ù„Ù„Ù…Ø³ =========
    document.addEventListener('touchmove', (e) => {
      if (!dragInfo) return;
      const touch = e.touches[0];
      if (!touch) return;
      e.preventDefault(); // Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠÙƒ

      const { box, offsetX, offsetY } = dragInfo;
      const containerRect = container.getBoundingClientRect();

      let newLeft = touch.clientX - containerRect.left - offsetX;
      let newTop = touch.clientY - containerRect.top - offsetY;

      const maxLeft = containerRect.width - box.offsetWidth;
      const maxTop = containerRect.height - box.offsetHeight;

      newLeft = Math.max(0, Math.min(newLeft, maxLeft));
      newTop = Math.max(0, Math.min(newTop, maxTop));

      box.style.left = newLeft + 'px';
      box.style.top = newTop + 'px';
    }, { passive: false });

    document.addEventListener('touchend', () => {
      if (dragInfo && dragInfo.box) {
        dragInfo.box.contentEditable = 'true';
      }
      dragInfo = null;
    });

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ®Ø§Ø±Ø¬ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª
    document.addEventListener('click', (e) => {
      if (!container.contains(e.target) && !toolbar.contains(e.target)) {
        if (activeBox) activeBox.classList.remove('active');
        activeBox = null;
      }
    });

    // ========= Ø­Ø°Ù Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­Ø¯Ø¯ =========
    deleteTextBtn.addEventListener('click', () => {
      if (activeBox) {
        activeBox.remove();
        activeBox = null;
      }
    });

    // ========= ØªØºÙŠÙŠØ± Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø®Ø· =========
    fontFamilySelect.addEventListener('change', () => {
      if (activeBox) {
        activeBox.style.fontFamily = fontFamilySelect.value;
      }
    });

    fontSizeInput.addEventListener('input', () => {
      if (activeBox) {
        activeBox.style.fontSize = fontSizeInput.value + 'px';
      }
    });

    fontColorInput.addEventListener('input', () => {
      if (activeBox) {
        activeBox.style.color = fontColorInput.value;
      }
    });

    // ØªØ¹Ø±ÙŠØ¶ Ø§Ù„Ù†Øµ
    boldBtn.addEventListener('click', () => {
      if (!activeBox) return;
      const style = window.getComputedStyle(activeBox);
      const fw = style.fontWeight;
      const isBold = fw === '700' || fw === 'bold';
      activeBox.style.fontWeight = isBold ? 'normal' : 'bold';
      boldBtn.classList.toggle('active', !isBold);
    });

    // ========= ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© =========
    exportBtn.addEventListener('click', () => {
      if (!img.complete) {
        alert('Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ØªÙƒØªÙ…Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.');
        return;
      }

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const imgWidth = img.naturalWidth;
      const imgHeight = img.naturalHeight;

      canvas.width = imgWidth;
      canvas.height = imgHeight;

      // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      ctx.drawImage(img, 0, 0, imgWidth, imgHeight);

      // Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
      const displayWidth = img.clientWidth;
      const displayHeight = img.clientHeight;

      const scaleX = imgWidth / displayWidth;
      const scaleY = imgHeight / displayHeight;

      ctx.textBaseline = 'top';
      ctx.textAlign = 'left';

      const boxes = container.querySelectorAll('.text-box');
      boxes.forEach((box) => {
        const style = window.getComputedStyle(box);

        const offsetLeft = box.offsetLeft;
        const offsetTop = box.offsetTop;

        const paddingLeft = parseFloat(style.paddingLeft) || 0;
        const paddingTop = parseFloat(style.paddingTop) || 0;

        const boxLeft = (offsetLeft + paddingLeft) * scaleX;
        const boxTop = (offsetTop + paddingTop) * scaleY;

        const fontSizeScreen = parseFloat(style.fontSize);
        const fontSize = fontSizeScreen * scaleY;

        const fontFamily = style.fontFamily;
        const color = style.color;
        const fw = style.fontWeight;
        const isBold = fw === '700' || fw === 'bold';

        ctx.font = (isBold ? 'bold ' : '') + fontSize + 'px ' + fontFamily;
        ctx.fillStyle = color;

        const text = box.innerText.replace(/\r/g, '');
        const lines = text.split('\n');
        const lineHeight = fontSize * 1.2;

        lines.forEach((line, index) => {
          const x = boxLeft;
          const y = boxTop + index * lineHeight;
          ctx.fillText(line, x, y);
        });
      });

      const link = document.createElement('a');
      link.download = 'a1-with-text.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  </script>
</body>
</html>
